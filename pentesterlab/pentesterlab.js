var form = document.forms[1]
var anchor = document.querySelector('.content')


var url = form.action

// input min
var input = document.createElement('input')
input.id = 'min'
input.placeholder = 'min'
input.style.width = '50px'
anchor.appendChild(input)

// max
var input = document.createElement('input')
input.id = 'max'
input.placeholder = 'max'
input.style.width = '50px'
anchor.appendChild(input)

// select
var select = document.createElement('select')
select.setAttribute('multiple', '')
select.id = 'my-categories'
select.placeholder = 'max'
select.style.width = '250px'
select.style.height = '400px'
Array.from(document.querySelector('[name="category"]').options).forEach((ele, i) => { 
    select.options[i] = new Option(ele.value, ele.value)
})
anchor.appendChild(select)

// brute button
var btn = document.createElement('button')
btn.innerText = 'Brute'
btn.onclick = brute
anchor.appendChild(btn)

// output
var output = document.createElement('div')
output.id = 'output'
anchor.appendChild(output)



async function brute(e) {
    var token = document.querySelector('[name="authenticity_token"]').value
    var filename = document.querySelector('#filename').value
    var options = Array.from(document.querySelector('[name="category"]').options).map(ele => { return ele.value })
    var token = document.querySelector('[name="authenticity_token"]').value
    var categories
    if (document.querySelector('#my-categories').selectedOptions.length == 0)
        categories = Array.from(document.querySelector('[name="category"]').options).map(ele => { return ele.value })
    else 
        categories = Array.from(document.querySelector('#my-categories').selectedOptions).map(ele => { return ele.value })
    var min = parseInt(document.querySelector('#min').value)
    var max = parseInt(document.querySelector('#max').value)
    var diff = max - min + 1
    const num_loops = Array.from(Array(diff).keys())

    var results = []

    for await (let x of num_loops) {
        let line = min + x 

        let  y = 1
        for await (let category of categories) {
            let html = await fetch(url, {
                "headers": {
                    "content-type": "application/x-www-form-urlencoded"
                },
                "body": `utf8=%E2%9C%93&authenticity_token=${encodeURIComponent(token)}&filename=${encodeURIComponent(filename)}&line=${line}&category=${encodeURIComponent(category)}&commit=submit`,
                "method": "POST",
                "mode": "cors",
                "credentials": "include",
                redirect: 'follow'
            }).then(resp => { return resp.text() }).then(text => {  return text })

            results.push({
                category: category,
                line: line,
                length: html.length
            })
                    
            // find if correct is chosen
            var control = results[0]
            var correct = results.filter(ele => { return ele.length != control.length })[0]
    
            // output to window
            document.querySelector('#output').innerText = 
            `${correct?.category || ''} : ${correct?.line || ''}\n` + 
            `${y++} / ${categories.length} | ${x + 1} / ${num_loops.length}`    
        }


        console.log(x + ' / ' + num_loops.length)
    }



} 

